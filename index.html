<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI 財經科技終端</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #050a14; --panel: #0f172a; --cyan: #22d3ee; --rose: #f43f5e; --emerald: #10b981; }
        body { background: var(--bg); color: #e2e8f0; font-family: 'Segoe UI', system-ui; margin: 0; padding: 20px; }
        .terminal { max-width: 1100px; margin: 0 auto; border: 1px solid #1e293b; padding: 20px; border-radius: 8px; box-shadow: 0 0 20px rgba(34,211,238,0.1); }
        .header { display: flex; justify-content: space-between; border-bottom: 2px solid #1e293b; padding-bottom: 15px; margin-bottom: 20px; }
        .tag { background: #1e293b; padding: 4px 12px; border-radius: 20px; font-size: 12px; border: 1px solid var(--cyan); }
        .chart-container { background: var(--panel); padding: 20px; border-radius: 12px; margin-bottom: 25px; height: 300px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .list-box { background: var(--panel); border-radius: 12px; padding: 15px; border: 1px solid #1e293b; }
        .item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #1e293b; cursor: pointer; transition: 0.2s; }
        .item:hover { background: #1e293b; }
        .price-up { color: var(--rose); font-weight: bold; }
        .price-down { color: var(--emerald); font-weight: bold; }
        #overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); z-index:99; }
        #modal { display: none; position: fixed; top:50%; left:50%; transform: translate(-50%,-50%); background: var(--panel); padding: 30px; border: 1px solid var(--cyan); border-radius: 16px; z-index:100; min-width: 300px; }
    </style>
</head>
<body>
    <div class="terminal">
        <div class="header">
            <h2 style="margin:0; color:var(--cyan)">TWSE MARKET ANALYZER v2.0</h2>
            <div id="status-tag" class="tag">掃描中...</div>
        </div>

        <div class="chart-container">
            <canvas id="marketChart"></canvas>
        </div>

        <div class="grid">
            <div class="list-box">
                <h3 style="color:var(--rose)">▲ TOP 10 GAINERS</h3>
                <div id="gainers"></div>
            </div>
            <div class="list-box">
                <h3 style="color:var(--emerald)">▼ TOP 10 LOSERS</h3>
                <div id="losers"></div>
            </div>
        </div>
    </div>

    <div id="overlay" onclick="closeModal()"></div>
    <div id="modal">
        <h2 id="m-title" style="color:var(--cyan)"></h2>
        <div id="m-body" style="line-height: 2;"></div>
        <button onclick="closeModal()" style="margin-top:20px; width:100%; padding:10px; background:var(--cyan); border:none; border-radius:8px; font-weight:bold; cursor:pointer">CLOSE</button>
    </div>

    <script>
        let myChart;
        fetch('./data.json?t=' + Date.now()).then(res => res.json()).then(data => {
            const statusTag = document.getElementById('status-tag');
            statusTag.innerText = data.is_closed ? `● 盤後更新: ${data.update_time}` : `○ 盤中觀測: ${data.update_time}`;
            
            renderUI(data.gainers, 'gainers', 'price-up');
            renderUI(data.losers, 'losers', 'price-down');
            initChart(data.gainers, data.losers);
        });

        function renderUI(list, containerId, priceClass) {
            const box = document.getElementById(containerId);
            box.innerHTML = list.map(s => `
                <div class="item" onclick="showDetail('${s.證券名稱}', '${s.證券代號}', ${s.開盤價}, ${s.收盤價}, ${s.漲跌幅})">
                    <span>${s.證券代號} ${s.證券名稱}</span>
                    <span class="${priceClass}">${s.漲跌幅}%</span>
                </div>
            `).join('');
        }

        function initChart(gainers, losers) {
            const ctx = document.getElementById('marketChart').getContext('2d');
            const labels = [...gainers.map(s => s.證券名稱), ...losers.map(s => s.證券名稱)];
            const values = [...gainers.map(s => s.漲跌幅), ...losers.map(s => s.漲跌幅)];
            const colors = [...Array(10).fill('#f43f5e'), ...Array(10).fill('#10b981')];

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: '漲跌幅 (%)', data: values, backgroundColor: colors }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { y: { grid: { color: '#1e293b' } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function showDetail(name, code, open, close, change) {
            document.getElementById('m-title').innerText = `${name} (${code})`;
            document.getElementById('m-body').innerHTML = `
                <div>開盤價: <b style="color:#fff">${open}</b></div>
                <div>收盤價: <b style="color:#fff">${close}</b></div>
                <div>漲跌幅: <b style="${change > 0 ? 'color:var(--rose)' : 'color:var(--emerald)'}">${change}%</b></div>
            `;
            document.getElementById('modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    </script>
</body>
</html>
