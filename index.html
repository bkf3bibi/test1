<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>AI 財經科技終端 v3.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #050a14; --panel: #0f172a; --cyan: #22d3ee; --rose: #f43f5e; --emerald: #10b981; }
        body { background: var(--bg); color: #e2e8f0; font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .terminal { max-width: 900px; margin: 0 auto; border: 1px solid #1e293b; padding: 20px; border-radius: 12px; box-shadow: 0 0 20px rgba(34,211,238,0.2); }
        .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #1e293b; padding-bottom: 15px; margin-bottom: 20px; }
        .chart-container { background: var(--panel); padding: 20px; border-radius: 12px; height: 320px; margin-bottom: 20px; position: relative; }
        .control-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        select { width: 100%; padding: 12px; background: #1e293b; color: var(--cyan); border: 1px solid var(--cyan); border-radius: 8px; font-weight: bold; outline: none; }
        .info-card { background: var(--panel); padding: 20px; border-radius: 12px; border: 1px solid #1e293b; }
        .hint-text { color: #94a3b8; font-size: 13px; margin-top: 10px; display: block; text-align: center; }
        .tag { background: #1e293b; padding: 4px 12px; border-radius: 20px; font-size: 12px; border: 1px solid var(--cyan); }
    </style>
</head>
<body>
    <div class="terminal">
        <div class="header">
            <h2 style="margin:0; color:var(--cyan)">MARKET ANALYZER v3.0</h2>
            <div id="status-tag" class="tag">系統同步中...</div>
        </div>

        <div class="chart-container">
            <canvas id="marketChart"></canvas>
            <span id="obs-hint" class="hint-text"></span>
        </div>

        <div class="control-panel">
            <div>
                <label style="color:var(--rose); font-size:12px;">▲ 漲幅前十名</label>
                <select id="gainersList" onchange="syncSelection('gainers')"></select>
            </div>
            <div>
                <label style="color:var(--emerald); font-size:12px;">▼ 跌幅前十名</label>
                <select id="losersList" onchange="syncSelection('losers')"></select>
            </div>
        </div>

        <div id="detailCard" class="info-card">
            <h3 id="stockTitle" style="margin-top:0; color:var(--cyan)">-- 請選擇股票 --</h3>
            <div id="stockInfo" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"></div>
        </div>
    </div>

    <script>
        let globalData = {};
        let chartInstance;

        fetch('./data.json?t=' + Date.now()).then(r => r.json()).then(data => {
            globalData = data;
            document.getElementById('status-tag').innerText = (data.is_closed ? '● 盤後: ' : '○ 盤中: ') + data.update_time;
            
            if (!data.is_closed) {
                document.getElementById('obs-hint').innerText = "[盤中觀測中 顯示開盤價]";
            }

            initSelect('gainersList', data.gainers);
            initSelect('losersList', data.losers);

            // 初始顯示第一筆
            if(data.gainers.length > 0) {
                document.getElementById('gainersList').value = data.gainers[0].證券代號;
                syncSelection('gainers');
            }
        });

        function initSelect(id, list) {
            const el = document.getElementById(id);
            el.innerHTML = '<option value="">請選擇...</option>' + 
                list.map(s => `<option value="${s.證券代號}">${s.證券代號} ${s.證券名稱} (${s.漲跌幅.toFixed(2)}%)</option>`).join('');
        }

        function syncSelection(type) {
            const val = document.getElementById(type === 'gainers' ? 'gainersList' : 'losersList').value;
            if(!val) return;
            
            const stock = globalData[type].find(s => s.證券代號 === val);
            updateUI(stock);
        }

        function updateUI(s) {
            document.getElementById('stockTitle').innerText = `${s.證券名稱} (${s.證券代號})`;
            document.getElementById('stockInfo').innerHTML = `
                <div>開盤價: <b style="color:#fff">${s.開盤價.toFixed(2)}</b></div>
                <div>目前/收盤價: <b style="color:#fff">${s.收盤價.toFixed(2)}</b></div>
                <div style="grid-column: span 2">漲跌幅度: <b style="color:${s.漲跌幅 >= 0 ? 'var(--rose)' : 'var(--emerald)'}">${s.漲跌幅.toFixed(2)}%</b></div>
            `;
            drawChart(s);
        }

        function drawChart(s) {
            const ctx = document.getElementById('marketChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const isUp = s.漲跌幅 >= 0;
            const barColor = isUp ? '#f43f5e' : '#10b981';

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['開盤價', '當前價'],
                    datasets: [{
                        data: [s.開盤價, s.收盤價],
                        backgroundColor: ['#334155', barColor],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: '#ffffff' }, grid: { display: false } },
                        y: { ticks: { color: '#94a3b8' }, grid: { color: '#1e293b' } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
